#!/bin/bash
# Git pre-push hook
# Tests GitHub Actions workflows locally before allowing push

set +e  # Don't exit on error, we'll handle it manually

echo "üîç Running pre-push checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if act is installed
if ! command -v act &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: 'act' is not installed. Skipping workflow tests.${NC}"
    echo ""
    echo "To enable workflow testing, install act:"
    echo "  macOS: brew install act"
    echo "  Linux: https://github.com/nektos/act#installation"
    echo ""
    echo "Or set up git hooks with: ./scripts/setup-git-hooks.sh"
    exit 0
fi

WORKFLOW_FILE=".github/workflows/ci.yml"

# Check if workflow file exists
if [ ! -f "$WORKFLOW_FILE" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Workflow file not found: $WORKFLOW_FILE${NC}"
    exit 0
fi

echo "üß™ Testing GitHub Actions workflows locally..."
echo ""

# Test critical jobs only (backend and frontend builds)
# Platform-specific jobs (Windows/macOS) are skipped as they require specific runners
echo "Running critical workflow jobs..."
echo ""

# Test master-backend job
echo -n "Testing master-backend... "
act_output=$(act -j master-backend 2>&1)
act_exit_code=$?

if [ $act_exit_code -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} passed"
else
    echo -e "${RED}‚úó${NC} failed"
    echo ""
    echo -e "${RED}‚ùå Workflow test failed. Push aborted.${NC}"
    echo ""
    echo "Error details:"
    echo "$act_output" | tail -20 | sed 's/^/  /'
    echo ""
    echo "To test manually, run:"
    echo "  act -j master-backend"
    echo ""
    echo "To skip this check (not recommended), use:"
    echo "  git push --no-verify"
    exit 1
fi

# Test master-frontend job
echo -n "Testing master-frontend... "
act_output=$(act -j master-frontend 2>&1)
act_exit_code=$?

if [ $act_exit_code -eq 0 ]; then
    echo -e "${GREEN}‚úì${NC} passed"
else
    echo -e "${RED}‚úó${NC} failed"
    echo ""
    echo -e "${RED}‚ùå Workflow test failed. Push aborted.${NC}"
    echo ""
    echo "Error details:"
    echo "$act_output" | tail -20 | sed 's/^/  /'
    echo ""
    echo "To test manually, run:"
    echo "  act -j master-frontend"
    echo ""
    echo "To skip this check (not recommended), use:"
    echo "  git push --no-verify"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All workflow tests passed!${NC}"
echo ""

exit 0
